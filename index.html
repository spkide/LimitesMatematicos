<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Límites Matemáticos Arcade - Final Avanzado</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
    background: #121212;
    color: #fff;
    display: flex;
    justify-content: center;
    padding: 20px 10px;
    flex-direction: column;
    min-height: 100vh;
}
.game-container {
    background: #1e1e1e;
    padding: 20px;
    border-radius: 20px;
    width: 100%;
    max-width: 750px;
    text-align: center;
    position: relative;
    overflow: hidden;
}
#bubbleContainer {
    position: relative;
    height: 350px;
    margin-bottom: 20px;
    border: 2px solid #333;
    border-radius: 15px;
    overflow: hidden;
}
.bubble {
    position: absolute;
    background: #3498db;
    border-radius: 50%;
    padding: 10px 15px;
    font-weight: bold;
    cursor: pointer;
    transition: transform 0.3s, opacity 0.3s;
    user-select: none;
    white-space: nowrap;
    font-size: 0.9rem;
}
.bubble.correct { background: #2ecc71; }
.bubble.wrong { background: #e74c3c; }
.bubble.powerup { background: #f1c40f; color:#000; font-weight:bold; }
.progress { height: 20px; margin-bottom: 15px; background-color: #555; }
.history { margin-top: 15px; max-height: 150px; overflow-y: auto; text-align: left; font-size: 0.9rem; }
.history-item { margin-bottom: 3px; }
@media (max-width: 576px) {
    #bubbleContainer { height: 200px; }
    .bubble { padding: 8px 12px; font-size: 0.8rem; }
}
</style>
</head>
<body>

<div class="game-container">
    <h2>Límites Matemáticos Arcade</h2>
    <div class="d-flex justify-content-between flex-wrap mb-2">
        <p id="level" class="me-2">Nivel: 1</p>
        <p id="score" class="me-2">Puntaje: 0</p>
        <p id="highScore">Mejor Puntaje: 0</p>
    </div>
    <div class="progress">
        <div class="progress-bar" id="timeBar" style="width:100%"></div>
    </div>
    <p id="timer">Tiempo: 30s</p>
    <div id="bubbleContainer"></div>
    <select id="difficultyMode" class="form-select mb-2">
        <option value="easy">Fácil</option>
        <option value="medium" selected>Medio</option>
        <option value="hard">Experto</option>
    </select>
    <p id="feedback"></p>
    <div class="history" id="history"></div>
    <div id="chartContainer"><canvas id="scoreChart"></canvas></div>
</div>

<audio id="correctSound"><source src="https://freesound.org/data/previews/66/66717_931655-lq.mp3" type="audio/mpeg"></audio>
<audio id="wrongSound"><source src="https://freesound.org/data/previews/109/109662_945474-lq.mp3" type="audio/mpeg"></audio>
<audio id="powerupSound"><source src="https://freesound.org/data/previews/331/331912_3248244-lq.mp3" type="audio/mpeg"></audio>

<script>
let score=0, highScore=0, level=1, timeLeft=30, consecutive=0, timerInterval;
const problemPerLevel=3;
const bubbleContainer=document.getElementById('bubbleContainer');
const feedback=document.getElementById('feedback');
const scoreElement=document.getElementById('score');
const highScoreElement=document.getElementById('highScore');
const levelElement=document.getElementById('level');
const timeBar=document.getElementById('timeBar');
const historyDiv=document.getElementById('history');
const correctSound=document.getElementById('correctSound');
const wrongSound=document.getElementById('wrongSound');
const powerupSound=document.getElementById('powerupSound');
const difficultyMode=document.getElementById('difficultyMode');

let generatedProblems = []; // Evitar repeticiones

function generateProblem(){
    let problemText = "";
    let answer = 0;
    let unique = false;

    while(!unique){
        let diff = difficultyMode.value;
        let base = level;
        if(diff==="easy") base = Math.max(1, level-1);
        if(diff==="hard") base = level+2;

        const a = Math.floor(Math.random()*(base*5+1)+1);
        const b = Math.floor(Math.random()*(base*5+1));
        const c = Math.floor(Math.random()*(base*5+1)+1);
        const type = Math.floor(Math.random()*9); // Añadimos más tipos

        switch(type){
            case 0: problemText = `lim (x→∞) de (${a}x + ${b}) / (${c}x + 1)`; answer = +(a/c).toFixed(2); break;
            case 1: problemText = `lim (x→∞) de sqrt(${a}x^2 + ${b}x) / (${c}x)`; answer = +(Math.sqrt(a)/c).toFixed(2); break;
            case 2: problemText = `lim (x→∞) de (${a}^x) / (${a}^x + ${b})`; answer = 1; break;
            case 3: problemText = `lim (x→∞) de ln(${a}x + ${b}) / ln(${c}x + 1)`; answer = +(Math.log(a)/Math.log(c)).toFixed(2); break;
            case 4: problemText = `lim (x→∞) de (${a}x^2 + ${b}x) / (${c}x^2 + ${b})`; answer = +(a/c).toFixed(2); break;
            case 5: problemText = `lim (x→∞) de sqrt(${a}x^2 + ${b}) / ln(${c}x + 1)`; answer = +(Math.sqrt(a)/Math.log(c)).toFixed(2); break;
            case 6: problemText = `lim (x→∞) de (${a}^x + ln(${b}+1)) / (${a}^x + ${c})`; answer = 1; break;
            case 7: problemText = `lim (x→0) de (sin(${a}x)/(${b}x))`; answer = +(a/b).toFixed(2); break;
            case 8: problemText = `lim (x→0) de (1 - cos(${a}x)) / (${b}x^2)`; answer = +(a/(2*b)).toFixed(2); break;
        }

        if(!generatedProblems.includes(problemText)){
            generatedProblems.push(problemText);
            unique = true;
        }
    }

    return {problemText, answer};
}

// Timer
function updateTimeBar(){ timeBar.style.width=(timeLeft/30*100)+'%'; }
function startTimer(){ timerInterval=setInterval(()=>{
    timeLeft--; document.getElementById('timer').innerText=`Tiempo: ${timeLeft}s`;
    updateTimeBar();
    if(timeLeft<=0){ clearInterval(timerInterval); feedback.innerText="¡Se acabó el tiempo!"; gameOver(); }
},1000);}
startTimer();

function createBubble(problem){
    const bubble=document.createElement('div');
    bubble.classList.add('bubble');
    bubble.style.left=Math.random()*(bubbleContainer.clientWidth-120)+'px';
    bubble.style.bottom='0px';
    bubble.innerText=problem.problemText;
    bubble.dataset.answer=problem.answer;

    const isPowerup=Math.random()<0.1;
    if(isPowerup){
        bubble.classList.add('powerup');
        bubble.innerText='POWER-UP';
        bubble.dataset.power='time';
    }

    bubbleContainer.appendChild(bubble);
    let move=setInterval(()=>{
        let bottom=parseInt(bubble.style.bottom);
        if(bottom>bubbleContainer.clientHeight-50){ clearInterval(move); bubble.remove(); return; }
        bubble.style.bottom=bottom+1+'px';
    },10);

    bubble.addEventListener('click',()=>{
        if(isPowerup){
            powerupSound.play();
            timeLeft+=10;
            score+=20;
            historyDiv.innerHTML+=`<div class="history-item text-warning">⚡ Power-Up: +10s y +20 puntos</div>`;
        }else{
            let userAnswer=prompt(`Resuelve: ${problem.problemText}`);
            if(parseFloat(userAnswer)===problem.answer){
                bubble.classList.add('correct'); correctSound.play();
                score+=10; consecutive++; timeLeft=30;
                historyDiv.innerHTML+=`<div class="history-item text-success">✔ ${problem.problemText} = ${problem.answer}</div>`;
            }else{
                bubble.classList.add('wrong'); wrongSound.play();
                score=Math.max(0,score-5); consecutive=0;
                historyDiv.innerHTML+=`<div class="history-item text-danger">✖ ${problem.problemText} = ${problem.answer}</div>`;
            }
        }
        bubble.remove();
        updateScore();
        if(consecutive>=problemPerLevel){ level++; consecutive=0; updateChart(); }
    });
}

function spawnBubbles(){ setInterval(()=>{ createBubble(generateProblem()); },1500);}
spawnBubbles();

function gameOver(){ alert(`Juego terminado. Puntaje: ${score}`); }

function updateScore(){
    scoreElement.innerText=`Puntaje: ${score}`;
    highScore=Math.max(score,highScore);
    highScoreElement.innerText=`Mejor Puntaje: ${highScore}`;
    levelElement.innerText=`Nivel: ${level}`;
}

// Chart.js
const ctx=document.getElementById('scoreChart').getContext('2d');
const scoreChart=new Chart(ctx,{ type:'bar', data:{ labels:[], datasets:[{label:'Puntaje por Nivel', data:[], backgroundColor:'rgba(255, 206, 86, 0.6)', borderColor:'rgba(255, 206, 86, 1)', borderWidth:1}] }, options:{ responsive:true, scales:{y:{beginAtZero:true}}}});
function updateChart(){ scoreChart.data.labels.push(`Nivel ${level-1}`); scoreChart.data.datasets[0].data.push(score); scoreChart.update(); }
</script>
</body>
</html>
